<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pantalla de Turnos</title>
  <link rel="stylesheet" href="./src/libs/bootstrap/bootstrap.min.css">
  <link rel="icon" href="./src/media/images/LOGOS ARQUIDOCESIS Y FILIALES-09 (1).png" type="image/png">

  <style>

    @font-face{
  font-family: "Roboto";
  src: url("./src/fonts/roboto/Roboto-Regular.woff2") format("woff2");
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}

@font-face{
  font-family: "Roboto";
  src: url("./src/fonts/roboto/Roboto-Bold.woff2") format("woff2");
  font-weight: 700;
  font-style: normal;
  font-display: swap;
}

@font-face{
  font-family: "Roboto";
  src: url("./src/fonts/roboto/Roboto-Black.woff2") format("woff2");
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}

    :root{
      --bg:#f6f8fc; --card:#fff; --border:#e6eaf2;
      --text:#0f172a; --muted:#64748b;
      --accent:#2563eb; --cyan:#06b6d4; --ok:#16a34a; --warn:#f59e0b; --call:#ef4444;
    }
    html, body { color-scheme: light; }
    body{
      background: linear-gradient(180deg, #f7f9ff, var(--bg));
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .app-shell{
      height: 100vh;
      display: grid;
      grid-template-rows: 88px 1fr ;
      gap: 12px;
      padding: 14px;
    }

/* ===== Overlay de llamado (mismo estilo blanco de la p√°gina) ===== */
.call-overlay{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998;
  background: rgba(15,23,42,.25);    /* igual que audio-gate */
  backdrop-filter: blur(6px);
  padding: 18px;
}

.call-overlay.show{ display:flex; }

.call-box{
  width: min(980px, 92vw);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 22px;
  box-shadow: 0 20px 50px rgba(15,23,42,.18);
  padding: 20px 22px 18px;
  animation: callIn .18s ease-out;
}

.call-top{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.call-pill{
  display:inline-flex;
  align-items:center;
  gap: 10px;
  font-weight: 950;
  letter-spacing: .6px;
  padding: 8px 12px;
  border-radius: 999px;
  color: #7f1d1d;
  background: rgba(239,68,68,.10);
  border: 1px solid rgba(239,68,68,.28);
}

.call-dot{
  width: 10px; height: 10px; border-radius: 999px;
  background: var(--call);
  box-shadow: 0 0 0 4px rgba(239,68,68,.18);
  animation: callPulse 0.75s ease-in-out infinite;
}

.call-ub{
  color: var(--muted);
  font-weight: 900;
  font-size: 14px;
  text-transform: uppercase;
  white-space: nowrap;
}

.call-patient{
  color: var(--text);
  font-weight: 1000;
  font-size: clamp(44px, 4.2vw, 82px);
  line-height: 1.05;
  margin: 8px 0 14px;
  text-align: center;
  text-transform: uppercase;
  animation: callFlash 0.75s ease-in-out infinite;
}

.call-row{
  display:flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
  margin-bottom: 8px;
}

.call-chip{
  background: rgba(144,28,34,1);
  border: 1px solid rgba(222, 245, 11, 0.89);
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 1000;
  font-size: clamp(18px, 2.0vw, 30px);
  color: #ffffff;
  white-space: nowrap;
}

.call-chip2{
  background: rgba(6, 181, 212, 0.863);
  border: 1px solid rgba(6,182,212,.25);
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 1000;
  font-size: clamp(18px, 2.0vw, 30px);
  color: #0b3a42;
  white-space: nowrap;
}

.call-sub{
  text-align:center;
  color: var(--muted);
  font-weight: 800;
  font-size: 16px;
  margin-top: 8px;
}

@keyframes callPulse{
  0%,100% { transform: scale(1); }
  50%     { transform: scale(1.06); }
}
@keyframes callFlash{
  0%,100% { opacity: 1; }
  50%     { opacity: .72; }
}
@keyframes callIn{
  from { transform: translateY(8px); opacity: .85; }
  to   { transform: translateY(0); opacity: 1; }
}

    /* Header */
    .topbar{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px 16px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow: 0 12px 26px rgba(15,23,42,.08);
    }
    .brand{ display:flex; align-items:center; gap: 14px; }
    .logo-box{
      width: 130px; height: 75px; border-radius: 16px;
      background: #f1f5ff; border: 1px solid var(--border);
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .logo-box img{ width:100%; height:100%; object-fit: cover; }
    .brand h1{ font-size: 32px; margin: 0;font-weight: 800; }
    .brand small{ color: var(--muted); display:block; margin-top:2px; }
    .clock{ text-align:right; min-width: 170px; }
    .clock .time{ font-size: 36px; font-weight: 900; }
    .clock .date{ color: var(--muted); font-size: 20px; text-transform: capitalize; }

    /* Main */
    .main{
      display:grid;
      grid-template-columns: 0.7fr .85fr;
      gap: 12px;
      min-height: 0;
    }
    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 12px 26px rgba(15,23,42,.08);
      overflow: hidden;
      min-height: 0;
    }
    .panel-header{
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, #ffffff, #fbfcff);
      gap: 10px;
    }
    .panel-title{
      margin:0; font-size: 13px; color: var(--muted);
      letter-spacing: .5px; text-transform: uppercase; font-weight: 800; white-space: nowrap;
    }
    .badge-soft{
      background: rgba(37,99,235,.10); border: 1px solid rgba(37,99,235,.25);
      color: #0b2a6f; padding: 6px 10px; border-radius: 999px;
      font-weight: 900; font-size: 12px; white-space: nowrap;
    }
    .badge-call{
      background: rgba(239,68,68,.10); border: 1px solid rgba(239,68,68,.28);
      color: #7f1d1d; padding: 6px 10px; border-radius: 999px;
      font-weight: 950; font-size: 12px; white-space: nowrap; display:none;
    }
    .badge-call.show{ display:inline-flex; gap: 8px; align-items:center; }
    .dot{ width: 10px; height: 10px; border-radius: 999px; background: var(--call); box-shadow: 0 0 0 4px rgba(239,68,68,.18); }

    /* Video */
    .video-wrap{ height: 100%;display:flex; flex-direction: column; min-height: 0; }
    .video-stage{ position: relative; flex: 1; min-height: 0; background: #eef2ff; }
    video{ width:100%; height:100%; object-fit: cover; display:block; }
    .video-overlay{ position:absolute; inset:0; background: linear-gradient(180deg, rgba(255,255,255,0), rgba(15,23,42,.08)); }
    .video-caption{
      position:absolute; left:16px; right:16px; bottom:14px;
      display:flex; justify-content:space-between; align-items:flex-end; gap: 12px;
    }
    .caption-left{ max-width: 75%; }
    .caption-left .headline{ font-size: 22px; font-weight: 950; margin:0 0 4px 0; }
    .caption-left .sub{ margin:0; color: rgba(15,23,42,.72); font-size: 14px; font-weight: 700; }

    /* Turnos */
    .turnos-wrap{ height: 100%;display:grid; grid-template-rows: auto auto 1fr; min-height: 0; }
    .current{
      padding: 14px 16px 12px; border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(37,99,235,.08), rgba(37,99,235,.03));
      transition: box-shadow .2s ease, outline .2s ease;
    }
    .current.calling{ outline: 3px solid rgba(239,68,68,.35); box-shadow: 0 0 0 6px rgba(239,68,68,.12) inset; }
    .current .label{ color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .5px; font-weight: 900; }
    .current .patient{ font-size: 45px; font-weight: 950; margin: 6px 0 4px; line-height: 1.1; }
    .row-pills{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
    .pill{ background: rgba(144,28,34,1); border: 1px solid rgba(22,163,74,.25); padding: 6px 10px; border-radius: 999px; font-weight: 950; color: #ffffff; }
    .pill2{ background: rgba(6,182,212,.50); border: 1px solid rgba(6,182,212,.50); padding: 6px 10px; border-radius: 999px; font-weight: 950; color: #0b3a42; }

    .queue-head{  height: 35px;padding: 10px 16px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .queue-head .left{ color: var(--muted); text-transform: uppercase; letter-spacing: .5px; font-size: 12px; font-weight: 900; }
    .queue-head .count{ color: var(--muted); font-weight: 900; font-size: 12px; }

    .queue{ padding: 10px 12px 12px; min-height: 0; overflow:hidden; }
    .queue-list{ height: 100%; overflow:auto; padding-right:4px; }
    .queue-item{
      display:grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items:center;
      padding: 10px 10px; border-radius: 14px; border: 1px solid var(--border);
      background: #fbfcff; margin-bottom: 10px;
    }
    .queue-item .name{ font-size: 30px; font-weight: 950; margin: 0; }
    .queue-item .meta{ margin:2px 0 0; color: var(--muted); font-size: 14px; font-weight:700; }
    .room-tag{
      background: rgba(144,28,34,1); border: 1px solid rgba(245,158,11,.30);
      padding: 7px 10px; border-radius: 999px; font-weight: 950; font-size: 22px;
      color: #ffffff; white-space: nowrap;
    }
    .ubi-tag{
      background: rgba(144,28,34,1); border: 1px solid rgba(245,158,11,.30);
      padding: 7px 10px; border-radius: 999px; font-weight: 950; font-size: 22px;
      color: #ffffff; white-space: nowrap;
    }


    /* Footer */
    .footer{
      background: var(--card); border: 1px solid var(--border); border-radius: 18px;
      padding: 10px 14px; display:flex; align-items:center; justify-content:space-between;
      color: rgba(15,23,42,.72); font-size: 14px; overflow:hidden; white-space: nowrap;
      box-shadow: 0 12px 26px rgba(15,23,42,.08);
    }
    .ticker{ overflow:hidden; white-space: nowrap; flex: 1; font-weight: 800; }
    .ticker span{ display:inline-block; padding-left: 100%; animation: scroll 18s linear infinite; }
    @keyframes scroll { 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    /* Audio gate */
    .audio-gate{
      position: fixed; inset: 0; background: rgba(15,23,42,.25); backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:center; padding: 18px; z-index: 9999;
    }
    .audio-card{
      width: min(520px, 92vw); background: #fff; border: 1px solid var(--border);
      border-radius: 18px; box-shadow: 0 20px 50px rgba(15,23,42,.18); padding: 18px;
    }
    .audio-card h2{ margin: 0 0 6px 0; font-size: 18px; font-weight: 950; }
    .audio-card p{ margin: 0 0 14px 0; color: var(--muted); font-weight: 700; font-size: 14px; }

    @media (max-width: 992px){
      body{ overflow:auto; } .app-shell{ height:auto; } .main{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>


<div id="callOverlay" class="call-overlay">
  <div class="call-box">
    <div class="call-top">
      <div class="call-pill"><span class="call-dot"></span>TURNO</div>
      <div class="call-ub" id="callUb"></div>
    </div>

    <div class="call-patient" id="callPatient">PACIENTE</div>

    <div class="call-row">
      <div class="call-chip" id="callRoom">CONSULTORIO</div>
      <div class="call-chip2" id="callSpec">ESPECIALIDAD</div>
      <div class="call-chip" id="callUbi">UBICACION</div>
    </div>

    <div class="call-sub" id="callHint">Por favor, ac√©rquese al consultorio indicado.</div>
  </div>
</div>

<!-- (Opcional) Sonido corto de alerta -->
<audio id="callDing" preload="auto" src="./src/media/sounds/DingDong.mp3"></audio>



  <div class="audio-gate" id="audioGate">
    <div class="audio-card">
      <h2>Habilitar sonido</h2>
<p>Seleccione la ubicaci√≥n y haga clic para activar la voz de los llamados.</p>

    <label class="form-label fw-bold">Ubicaci√≥n</label>
    <select class="form-select mb-3" id="selUbicacion">
      <option value="">GENERAL (todas)</option>
      <option value="PRIMER PISO">PRIMER PISO</option>
      <option value="SOTANO">SOTANO</option>
    </select>
      <button class="btn btn-primary w-100" id="btnEnableAudio">Activar Audio</button>
    </div>
  </div>

  <div class="app-shell">
    <header class="topbar">
      <div class="brand">
        <div class="logo-box">
          <img src="./src/media/images/LOGO-ISOTIPO.png" alt="Logo">
        </div>
        <div>
          <h1>FUNDASEN</h1>
          <small>Turnos en vivo ‚Ä¢ Mantenga su c√©dula a la mano</small>
        </div>
      </div>
      <div class="clock">
        <div class="time" id="time">--:--</div>
        <div class="date" id="date">--</div>
      </div>
    </header>

    <main class="main">
      <section class="panel video-wrap">
        <div class="panel-header">
          <p class="panel-title">Fundasen Informa (TEXTO PARA LA LECTURA)</p>
          <span class="badge-soft" id="videoBadge">Info</span>
        </div>
        <div class="video-stage">
          <video id="promoVideo" autoplay muted playsinline></video>
          <div class="video-overlay"></div>
          <div class="video-caption">
            <div class="caption-left">
              <p class="headline" id="videoTitle">Bienvenidos</p>
              <p class="sub" id="videoSub">√öltimo Turno.</p>
            </div>
          </div>
        </div>
      </section>

      <section class="panel turnos-wrap">
        <div class="panel-header">
          <p class="panel-title">Turnos</p>
          <span class="badge-call" id="callBadge">
            <span class="dot"></span><span id="callText">LLAMANDO</span>
          </span>
          <span class="badge-soft" id="statusBadge">Conectando...</span>
        </div>

        <div class="current" id="currentCard">
          <div class="label">Turno actual</div>
          <div class="patient" id="currentPatient">ESPERANDO...</div>
          <div class="row-pills">
            <span class="pill" id="currentRoom">‚Äî</span>
            <span class="pill2" id="currentExtra">‚Äî</span>
            <span class="pill" id="currentUbi">‚Äî</span>
          </div>
        </div>

        <div class="queue-head">
          <div class="left">√öltimos llamados</div>
          <div class="count" id="queueCount">0</div>
        </div>

        <div class="queue">
          <div class="queue-list" id="queueList"></div>
        </div>
      </section>
    </main>

   <!-- <footer class="footer">
      <div class="ticker">
        <span>üîî Mant√©ngase atento a su llamado ‚Ä¢ Si no est√° presente, su turno puede pasar al siguiente.</span>
      </div>
      <div style="margin-left:14px;color:var(--muted);font-weight:900">v1.2</div>
    </footer>-->
  </div>
<script>
    // ==========================================
    // CONFIGURACI√ìN
    // ==========================================
    const VIDEO_VOL_NORMAL = 1.0;   // volumen habitual
    const VIDEO_VOL_DUCK = 0.15;    // volumen mientras narra (0.1‚Äì0.3 recomendado)
    const BASE_HOST = "10.1.0.6:8080"; 
    const WS_URL = (location.protocol === 'https:' ? 'wss' : 'ws') + '://' + BASE_HOST + '/ws';  
    let MI_UBICACION = localStorage.getItem("MI_UBICACION") || "";
    const API_HISTORY_BASE =
    (location.protocol === 'https:' ? 'https' : 'http') + '://' + BASE_HOST + '/api/turnos/estado/';

const selUb = document.getElementById("selUbicacion");
if (selUb) {
  selUb.value = MI_UBICACION;

  selUb.addEventListener("change", () => {
    applyUbicacion(selUb.value);
  });
}

    // =======================
    // UTILIDADES
    // =======================

function getHistoryUrl() {
  const ub = (MI_UBICACION ?? "").trim();
  return ub ? `${API_HISTORY_BASE}${encodeURIComponent(ub)}` : API_HISTORY_BASE;
}



    function applyUbicacion(newUb) {
  MI_UBICACION = (newUb ?? "").trim();
  localStorage.setItem("MI_UBICACION", MI_UBICACION);

  // limpiar cola para que no se cuelen turnos de otra ubicaci√≥n
  state.queue = [];

  // si el current no cumple, lo borramos
  if (state.current && !matchUbicacion(state.current)) {
    state.current = null;
  }

  // filtrar historial existente
  state.history = (state.history || []).filter(matchUbicacion);

  render();   // refresco inmediato

  // traer verdad de BD (ya filtrada en front)
  init();
}
    function toTitleCase(str) {
      if (!str) return "";
      return String(str).toLowerCase().split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
    }



    // Normaliza el payload entrante (WS/API) a una estructura interna √∫nica
    // ‚úÖ Internamente todo usa: id_consulta
    function normalizeTurno(t) {
      if (!t) return null;

      const id = t.id_consulta ?? t.consulta_id ?? t.consultaId ?? t.consultaID ?? null;
      if (id === null || id === undefined || String(id).trim() === "") return null;

      return {
        id_consulta: String(id),
        paciente: t.paciente ?? "",
        medico: t.medico ?? "",
        consultorio: t.consultorio ?? "",
        especialidad: t.especialidad ?? "",
        localidad: t.localidad ?? "",
        ubicacion: t.ubicacion ?? ""
      };
    }

    function normTxt(s){
  return String(s ?? "").trim().toLowerCase().replace(/\s+/g, " ");
}

function matchUbicacion(turno){
  if (!MI_UBICACION || normTxt(MI_UBICACION) === "general") return true;

  const uTurno = normTxt(turno?.ubicacion);
  const uPantalla = normTxt(MI_UBICACION);

  // Si el backend manda "General", se ve en todas
  if (uTurno === "general") return true;

  return uTurno === uPantalla;
}

    // =======================
    // RELOJ
    // =======================
    function tick(){
      const now = new Date();
      document.getElementById('time').textContent = now.toLocaleTimeString('es-EC', {hour:'2-digit', minute:'2-digit'});
      document.getElementById('date').textContent = now.toLocaleDateString('es-EC', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    }
    tick(); setInterval(tick, 1000);

    // =======================
    // VIDEOS
    // =======================
const videoEl = document.getElementById('promoVideo');
let promoIndex = 0;
let srcIndex = 0;

const promos = [
  {
    badge: "CAN'T STOP",
    title: "RED HOT CHILLI PEAPERS",
    sub: "CUALQUIER TEXTO DE SUB TITULO",
    srcs: [
      "./src/media/videos/Red Hot Chili Peppers - Can't Stop [Official Music Video].mp4",
    ]
  },
  {
    badge: "Freak On a Leash",
    title: "Korn",
    sub: "Pruebas",
    srcs: [
      "./src/media/videos/Korn - Freak On a Leash (Official HD Video).mp4"
    ]
  }
];

function setPromoUI(p){
  document.getElementById('videoBadge').textContent = p.badge || "Info";
  document.getElementById('videoTitle').textContent = p.title || "Video";
  document.getElementById('videoSub').textContent = p.sub || "";
}

function playNextVideo(){
  if (!promos.length) return;

  const p = promos[promoIndex];
  setPromoUI(p);

  const list = p.srcs || [];
  if (!list.length) return;

  videoEl.src = list[srcIndex];
  videoEl.play().catch(()=>{});

  // avanzar √≠ndices
  srcIndex++;
  if (srcIndex >= list.length) {
    srcIndex = 0;
    promoIndex = (promoIndex + 1) % promos.length;
  }
}

videoEl.addEventListener('ended', playNextVideo);
videoEl.addEventListener('error', playNextVideo);

// arranque
playNextVideo();
    // =======================
    // ESTADO GLOBAL
    // =======================
    const state = {
      current: null,      // El turno grande actual
      history: [],        // La lista de la derecha
      queue: [],          // COLA DE ESPERA (Buffer)
      isBusy: false       // SEM√ÅFORO: True si est√° hablando o procesando
    };

    // =======================
    // RENDERIZADO
    // =======================
    function render() {
      // A. Render Turno Grande
      if (state.current) {
          document.getElementById('currentPatient').textContent = toTitleCase(state.current.paciente);
          document.getElementById('currentRoom').textContent = toTitleCase(state.current.consultorio);
          document.getElementById('currentExtra').textContent = toTitleCase(state.current.especialidad);
          document.getElementById('currentUbi').textContent = toTitleCase(state.current.ubicacion);
      }

      // B. Render Historial (Lista Lateral)
      const list = document.getElementById('queueList');
      list.innerHTML = "";
      
      // Filtramos para que el turno ACTUAL no salga repetido en el historial visual
      const historialLimpio = state.history.filter(t => {
          if (!state.current) return true;
          return t.id_consulta !== state.current.id_consulta;
      });

      historialLimpio.slice(0, 10).forEach(p => {
        const item = document.createElement('div');
        item.className = 'queue-item';
        item.innerHTML = `
          <div>
            <p class="name">${toTitleCase(p.paciente)}</p>
            <p class="meta">${toTitleCase(p.especialidad)}</p>
          </div>
          <div class="room-tag">${toTitleCase(p.consultorio)}</div>
          <div class="ubi-tag">${toTitleCase(p.ubicacion)}</div>
        `;
        list.appendChild(item);
      });
      document.getElementById('queueCount').textContent = historialLimpio.length;
    }

    // =======================
    // GESTOR DE COLA (QUEUE MANAGER)
    // =======================
    
    // Funci√≥n principal que intenta procesar el siguiente elemento
    async function procesarCola() {
        // 1. REGLA DE ORO: Si est√° ocupado o no hay nada, no hacer nada.
        if (state.isBusy) return;
        if (state.queue.length === 0) return;

        // 2. BLOQUEAR EL SISTEMA
        state.isBusy = true;

        // 3. OBTENER DATOS
        const nuevoTurno = state.queue.shift(); // Sacar el primero de la fila (FIFO)

        // 4. ACTUALIZACI√ìN VISUAL INMEDIATA (Fase 1)
        // Movemos el actual al historial localmente para que se vea fluido
        if (state.current) {
            state.history.unshift(state.current);
        }
        state.current = nuevoTurno;
        render(); // Pinta la pantalla

        // 5. LLAMADA API (GET) - Como solicitaste
        // Hacemos el fetch AHORA para asegurar que el historial est√© sincronizado con BD
        try {
            console.log("Fetching historial actualizado..."); 
            const res = await fetch(getHistoryUrl());
            if (res.ok) {
                const data = await res.json();
                if (Array.isArray(data)) {
                    //state.history = data.map(normalizeTurno).filter(Boolean); // verdad de BD, normalizada
                    state.history = data.map(normalizeTurno).filter(Boolean).filter(matchUbicacion);
                    render(); // Repintamos la lista lateral
                }
            }
        } catch (e) {
            console.error("Error fetching history", e);
        }

        // 6. INICIAR AUDIO (Esto bloquear√° el siguiente turno hasta que termine)
        await hablar(nuevoTurno);

        // 7. DESBLOQUEAR Y REVISAR SI HAY M√ÅS
        state.isBusy = false;
        
        // Peque√±o delay para que no sea atropellado
        setTimeout(() => {
            procesarCola(); // Recursividad: Llamar al siguiente si existe
        }, 1000);
    }

    // =======================
    // AUDIO (PROMISIFIED)
    // =======================
    let audioEnabled = false;
    let voices = [];
    if ('speechSynthesis' in window) {
        window.speechSynthesis.onvoiceschanged = () => voices = window.speechSynthesis.getVoices();
    }


    function hablar(turno) {
  return new Promise((resolve) => {
    // UI visual de "Llamando"
    const badge = document.getElementById('callBadge');
    const card = document.getElementById('currentCard');
    badge.classList.add('show');
    card.classList.add('calling');
    document.getElementById('callText').textContent = "LLAMANDO...";

    // VIDEO: ducking con fade
    const videoEl = document.getElementById('promoVideo');
    const prevVol = (videoEl && typeof videoEl.volume === "number") ? videoEl.volume : 1.0;
    const DUCK_VOL = 0.05;     // volumen mientras narra
    const FADE_MS = 300;       // duraci√≥n del fade
    const STEP_MS = 25;        // suavidad

    let fadeTimer = null;
    let finished = false;

    function fadeTo(targetVol) {
      if (!videoEl || videoEl.muted) return;
      if (fadeTimer) clearInterval(fadeTimer);

      const startVol = videoEl.volume;
      const steps = Math.max(1, Math.round(FADE_MS / STEP_MS));
      const delta = (targetVol - startVol) / steps;
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        let next = videoEl.volume + delta;

        // clamp 0..1
        if (next < 0) next = 0;
        if (next > 1) next = 1;

        videoEl.volume = next;

        if (i >= steps) {
          videoEl.volume = targetVol;
          clearInterval(fadeTimer);
          fadeTimer = null;
        }
      }, STEP_MS);
    }

    // Bajar volumen ANTES de hablar
    showCallOverlay(turno);
    fadeTo(DUCK_VOL);

    const cleanup = () => {
      if (finished) return; // evita doble cleanup por onend/onerror/cancel
      finished = true;


      hideCallOverlay();
      // Restaurar volumen con fade
      fadeTo(prevVol);

      badge.classList.remove('show');
      card.classList.remove('calling');
      resolve();
    };

    // Si no hay audio habilitado, esperamos 4 seg y continuamos
    if (!audioEnabled || !('speechSynthesis' in window)) {
      setTimeout(cleanup, 4000);
      return;
    }

    // Configurar voz
    const txt = `Paciente ${toTitleCase(turno.paciente)}, pasar al ${toTitleCase(turno.consultorio)}, ${toTitleCase(turno.especialidad)}`;
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = "es-EC";
    u.volume = 1;
    u.rate = 0.9;

    const v = voices.find(vo => vo.lang.includes('es') && vo.name.includes('Google'))
            || voices.find(vo => vo.lang.includes('es'));
    if (v) u.voice = v;

    // Eventos para liberar la promesa
    u.onend = cleanup;
    u.onerror = cleanup;

    // Cancelar cualquier cosa previa y hablar
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  });
}

    // Bot√≥n activar audio
document.getElementById('btnEnableAudio').addEventListener('click', async () => {
    // 1) Tomar ubicaci√≥n desde el combo
  const selUb = document.getElementById("selUbicacion");
  MI_UBICACION = (selUb?.value ?? "").trim();  // "" => general
  localStorage.setItem("MI_UBICACION", MI_UBICACION);
  
  audioEnabled = true;
  document.getElementById('audioGate').style.display = 'none';

  // ‚úÖ Habilitar audio del video
  const videoEl = document.getElementById('promoVideo');
  videoEl.muted = false;
  videoEl.volume = 0.8;

  try { 
    await videoEl.play(); // por si el navegador paus√≥ el autoplay
  } catch (e) {
    console.log("No se pudo reproducir el video con audio:", e);
  }
  applyUbicacion(selUb?.value || "");
  document.getElementById('statusBadge').textContent = "En l√≠nea ‚Ä¢ " + (MI_UBICACION ? MI_UBICACION : "GENERAL");
});


    // =======================
    // CARGA INICIAL
    // =======================
    async function init() {
        try {
            const res = await fetch(getHistoryUrl());
            const data = await res.json();
            if (Array.isArray(data) && data.length > 0) {
                //const norm = data.map(normalizeTurno).filter(Boolean);
                const norm = data.map(normalizeTurno).filter(Boolean).filter(matchUbicacion);
                // Asumimos que norm[0] es el √∫ltimo llamado
                state.current = norm[0] || null;
                state.history = norm.slice(1);
                render();
            }
        } catch (e) { console.error("Error init:", e); }
    }


    // =======================
    // WEBSOCKET
    // =======================
    let socket;
    function connectWS() {
        console.log("Conectando WS...", WS_URL);
        socket = new WebSocket(WS_URL);
        
        socket.onopen = () => {
            document.getElementById('statusBadge').textContent = "En l√≠nea ‚Ä¢ " + (MI_UBICACION ? MI_UBICACION : "GENERAL");
            document.getElementById('statusBadge').style.color = "green";
            init(); // Cargar estado inicial
        };

        socket.onmessage = (event) => {
            try {
                const turno = normalizeTurno(JSON.parse(event.data));
                if (!turno || !turno.id_consulta) return;
                //if (MI_UBICACION && turno.ubicacion !== MI_UBICACION && turno.ubicacion !== 'General') return;
                if (!matchUbicacion(turno)) return;

                // FILTRO DE REPETIDOS (Doble clic):
                // Verificamos si ya est√° en cola o si es el actual
                const yaEnCola = state.queue.find(t => t.id_consulta === turno.id_consulta);
                const esActual = state.current && state.current.id_consulta === turno.id_consulta;
                
                if (!yaEnCola && !esActual) {
                    console.log("Nuevo turno encolado:", turno.paciente);
                    state.queue.push(turno); // 1. Solo pushear a la cola
                    procesarCola();          // 2. Intentar arrancar el procesador
                } else {
                    console.log("Turno ignorado (duplicado/actual)");
                }

            } catch (e) { console.error(e); }
        };

        socket.onclose = () => {
            document.getElementById('statusBadge').textContent = "Desconectado";
            document.getElementById('statusBadge').style.color = "red";
            setTimeout(connectWS, 3000);
        };
    }
    function showCallOverlay(turno){
  const ov = document.getElementById('callOverlay');
  if (!ov) return;

  document.getElementById('callPatient').textContent = toTitleCase(turno.paciente);
  document.getElementById('callRoom').textContent = toTitleCase(turno.consultorio);
  document.getElementById('callSpec').textContent = toTitleCase(turno.especialidad);
  document.getElementById('callUbi').textContent = toTitleCase(turno.ubicacion);
  document.getElementById('callUb').textContent = `Ubicaci√≥n: ${toTitleCase(turno.ubicacion)}`;

  ov.classList.add('show');

  // (Opcional) ding corto
  const ding = document.getElementById('callDing');
  if (ding && !ding.muted) {
    try { ding.currentTime = 0; ding.play().catch(()=>{}); } catch {}
  }
}

function hideCallOverlay(){
  const ov = document.getElementById('callOverlay');
  if (!ov) return;
  ov.classList.remove('show');
}


    connectWS();
</script>
</body>
</html>